name: CI
on:
  push:
    branches:
      - "master"
      - "main"
  pull_request:
    branches:
      - "master"
      - "main"

  workflow_dispatch:

jobs:
  build:
    name: Build
    strategy:
      matrix:
        target:
          # add more targets to build for more
          - distro_name: ubuntu
            distro_version: 24.04

    runs-on: ubuntu-latest
    steps:

    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: build in docker
      uses: docker/build-push-action@v6
      with:
        context: .  # this is necessary for .git to be available inside the container
        push: false
        file: docker/Dockerfile
        tags: et-platform:latest
        build-args: |
          BASE_DISTRO=${{ matrix.target.distro_name }}
          DISTRO_VERSION=${{ matrix.target.distro_version }}
          VERBOSE=1
        outputs: type=docker,dest=${{ runner.temp }}/platform.tar
    - name: Upload build image
      uses: actions/upload-artifact@v4
      with:
        name: platform
        path: ${{ runner.temp }}/platform.tar

  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: platform
          path: ${{ runner.temp }}
      - name: Load image
        run: |
          docker load --input ${{ runner.temp }}/platform.tar
          # run `docker image ls`, just to see that it is there
          docker image ls
      - name: Run tests in docker
        run: |
          docker run --rm -w /out -v ${{ runner.temp }}/out:/out et-platform:latest /bin/bash -c "/opt/et/bin/it_test_code_loading"
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ runner.temp }}/out
          if-no-files-found: error
      - name: Report test results
        run: |
          for file in ${{ runner.temp }}/out/*.log*; do
            echo "===== Test result: $file ====="
            cat "$file"
            echo "================================"
          done
